<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Copyparty Config Editor PRO - Fixed Dropdowns</title>
    <script src="parameters.js"></script>
    <style>
        :root {
            --bg: #f1f5f9; --panel: #ffffff; --border: #cbd5e1; --text: #1e293b;
            --accent: #2563eb; --inc: #3b82f6; --exc: #ef4444; --none: #94a3b8;
            --hook-bg: #fee2e2; --flag-bg: #fef9c3;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .share-panel {
            background: var(--panel); border: 2px solid var(--border);
            border-radius: 12px; padding: 25px; display: inline-flex;
            flex-direction: column; gap: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            min-width: 750px;
        }
        .header-row { display: flex; gap: 15px; align-items: center; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .header-row input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; flex: 1; font-family: monospace; }
        .main-row { display: flex; gap: 20px; align-items: flex-start; }
        .actors-group { display: flex; gap: 6px; }
        .channel-strip {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            background: #f8fafc; padding: 10px 6px; border-radius: 8px; border: 1px solid var(--border); width: 60px;
        }
        .knob { width: 24px; height: 24px; border-radius: 50%; background: var(--none); cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .knob.state-1 { background: var(--inc); }
        .knob.state-2 { background: var(--exc); }
        .vertical-input { writing-mode: vertical-rl; text-orientation: mixed; background: white; border: 1px solid var(--border); width: 32px; height: 110px; padding: 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .perms-group { display: flex; flex-direction: column; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); min-width: 140px; }
        .perm-columns { display: flex; gap: 15px; }
        .perm-col { display: flex; flex-direction: column; gap: 4px; font-size: 13px; font-weight: bold; }
        .action-btns { display: flex; gap: 5px; margin-top: 12px; }
        .action-btns button { font-size: 11px; padding: 5px; flex: 1; cursor: pointer; background: white; border: 1px solid var(--border); border-radius: 4px; font-weight: bold; }
        .options-container { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .option-row { display: flex; gap: 8px; align-items: center; padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); background: #fff; }
        .row-commented { opacity: 0.4; background: #f1f5f9 !important; border-style: dashed; }
        .opt-automation { background: var(--hook-bg) !important; border-color: #fca5a5; }
        .opt-flag-style { background: var(--flag-bg) !important; border-color: #fde047; }
        .sufu-input { width: 110px; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-family: monospace; font-weight: bold; }
        .val-input { flex: 1; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-family: monospace; }
        .desc-label { font-size: 11px; color: #64748b; width: 250px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; font-style: italic; }
        .output-area { width: 100%; min-height: 220px; background: #1e293b; color: #a5f3fc; border-radius: 8px; padding: 15px; font-family: 'Consolas', monospace; font-size: 13px; margin-top: 15px; border: none; }
        .delete-icon { color: #94a3b8; cursor: pointer; font-weight: bold; padding: 0 5px; }
    </style>
</head>
<body>

    <div class="share-panel">
        <div class="header-row">
            <b>VFS:</b> <input type="text" id="loc" placeholder="/media" oninput="updateOutput()">
            <b>HDD:</b> <input type="text" id="path" placeholder="/mnt/storage" oninput="updateOutput()">
        </div>

        <div class="main-row">
            <div class="actors-group" id="actor-grid"></div>
            <div class="perms-group">
                <div class="perm-columns" id="perm-matrix">
                    <div class="perm-col" id="acl-col-1"></div>
                    <div class="perm-col" id="acl-col-2"></div>
                </div>
                <div class="action-btns">
                    <button onclick="setACL(false)">None</button>
                    <button onclick="invertACL()">Inv</button>
                    <button onclick="setACL(true)">All</button>
                </div>
            </div>
        </div>

        <div id="dynamic-options-container" class="options-container"></div>
        <textarea class="output-area" id="config-output" spellcheck="false" oninput="parseConfig(this.value)"></textarea>
    </div>

    <datalist id="all-params-list"></datalist>
    <datalist id="users-list">
        <option value="bastian"><option value="rico"><option value="thomas"><option value="@acct"><option value="admin">
    </datalist>

    <script>
        const FLAG_CATS = ["storage", "upload", "limits", "rotation", "database", "media", "view", "security", "download"];
        let isUpdating = false;

        window.onload = function() {
            if (typeof SHARE_OPTIONS === 'undefined') return;
            setupEditor();
        };

        function setupEditor() {
            // 1. ACL Checkboxen
            const col1 = document.getElementById('acl-col-1');
            const col2 = document.getElementById('acl-col-2');
            const aclOpts = SHARE_OPTIONS.filter(o => o.configMode === 'acl');
            aclOpts.forEach((o, i) => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" value="${o.param}" onchange="updateOutput()"> ${o.param}`;
                (i < 5 ? col1 : col2).appendChild(label);
            });

            // 2. Datalist Flags
            const dl = document.getElementById('all-params-list');
            SHARE_OPTIONS.filter(o => o.category === "automation" || FLAG_CATS.includes(o.category)).forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.param;
                opt.innerText = `[${o.category}] ${o.desc}`;
                dl.appendChild(opt);
            });

            // 3. Mischpult (Fix: Explizites Setzen des List-Attributes)
            const grid = document.getElementById('actor-grid');
            grid.innerHTML = ""; 
            for(let i=0; i<8; i++) {
                const strip = document.createElement('div');
                strip.className = 'channel-strip';
                strip.innerHTML = `
                    <div class="knob" onclick="cycle(this)" data-state="0"></div>
                    <input type="text" list="users-list" class="vertical-input" placeholder="User..." oninput="updateOutput()">
                `;
                grid.appendChild(strip);
            }
            addOptionRow();
            updateOutput();
        }

        function addOptionRow(k = "", v = "", commented = false) {
            const container = document.getElementById('dynamic-options-container');
            const id = 'opt-' + Math.random().toString(36).substr(2, 5);
            const isFirst = container.children.length === 0;

            const div = document.createElement('div');
            div.className = 'option-row' + (commented ? ' row-commented' : '');
            div.id = id;
            div.innerHTML = `
                <input type="checkbox" onchange="toggleRow('${id}')" ${commented ? 'checked' : ''}>
                <input type="text" list="all-params-list" class="sufu-input" value="${k}" oninput="syncRow('${id}')">
                <input type="text" class="val-input" value="${v}" oninput="updateOutput()">
                <span class="desc-label">...</span>
                <span class="delete-icon" onclick="removeRow('${id}', ${isFirst})">${isFirst ? '' : '‚ùå'}</span>
            `;
            container.appendChild(div);
            if(k) syncRow(id);
        }

        function removeRow(id, first) { if(!first) { document.getElementById(id).remove(); updateOutput(); } }
        function toggleRow(id) { document.getElementById(id).classList.toggle('row-commented'); updateOutput(); }

        function syncRow(id) {
            const container = document.getElementById('dynamic-options-container');
            const row = document.getElementById(id);
            const key = row.querySelector('.sufu-input').value.trim();
            if (row === container.lastElementChild && key !== "") addOptionRow();
            
            const opt = SHARE_OPTIONS.find(o => o.param === key);
            row.classList.remove('opt-automation', 'opt-flag-style');
            if(opt) {
                row.querySelector('.desc-label').innerText = opt.desc;
                row.classList.add(opt.category === 'automation' ? 'opt-automation' : 'opt-flag-style');
            }
            updateOutput();
        }

        function cycle(el) {
            el.dataset.state = (parseInt(el.dataset.state) + 1) % 3;
            el.className = 'knob state-' + el.dataset.state;
            updateOutput();
        }

        function setACL(s) { document.querySelectorAll('#perm-matrix input').forEach(c => c.checked = s); updateOutput(); }
        function invertACL() { document.querySelectorAll('#perm-matrix input').forEach(c => c.checked = !c.checked); updateOutput(); }

        function updateOutput() {
            if (isUpdating) return;
            const loc = document.getElementById('loc').value || "/";
            const path = document.getElementById('path').value || "/";
            const perms = Array.from(document.querySelectorAll('#perm-matrix input:checked')).map(i => i.value).join('');
            let uAccs = [];
            document.querySelectorAll('.channel-strip').forEach(s => {
                const n = s.querySelector('input').value.trim();
                const st = parseInt(s.querySelector('.knob').dataset.state);
                if(n && st > 0) uAccs.push((st === 2 ? '-' : '') + n);
            });
            let config = `[${loc}]\n  res: ${path}\n`;
            if(perms && uAccs.length) config += `  accs:\n    ${perms}: ${uAccs.join(', ')}\n`;
            let f = "";
            document.querySelectorAll('.option-row').forEach(row => {
                const k = row.querySelector('.sufu-input').value.trim();
                const v = row.querySelector('.val-input').value.trim();
                const d = row.querySelector('input[type="checkbox"]').checked;
                if(k) f += `    ${d ? '# ' : ''}${k}${v ? ': ' + v : ''}\n`;
            });
            if(f) config += `  flags:\n${f}`;
            document.getElementById('config-output').value = config;
        }

        function parseConfig(val) {
            isUpdating = true;
            const lines = val.split('\n');
            const container = document.getElementById('dynamic-options-container');
            container.innerHTML = ""; // Reset
            
            document.querySelectorAll('#perm-matrix input').forEach(c => c.checked = false);
            document.querySelectorAll('.channel-strip').forEach(s => {
                s.querySelector('input').value = "";
                s.querySelector('.knob').dataset.state = 0;
                s.querySelector('.knob').className = "knob";
            });

            lines.forEach(line => {
                const raw = line.trim();
                if (raw.startsWith('[') && raw.endsWith(']')) document.getElementById('loc').value = raw.slice(1, -1);
                else if (raw.startsWith('res:')) document.getElementById('path').value = raw.split(':')[1].trim();
                else if (raw.includes(':') && !raw.startsWith('accs') && !raw.startsWith('flags')) {
                    const parts = raw.split(':');
                    const k = parts[0].trim();
                    const v = parts.slice(1).join(':').trim();
                    
                    if (/^[rwmda.GghA]+$/.test(k)) { 
                        k.split('').forEach(c => { const cb = document.querySelector(`#perm-matrix input[value="${c}"]`); if(cb) cb.checked = true; });
                        v.split(',').forEach((u, i) => {
                            if(i < 8) {
                                const strip = document.querySelectorAll('.channel-strip')[i];
                                const isExc = u.trim().startsWith('-');
                                strip.querySelector('input').value = isExc ? u.trim().substring(1) : u.trim();
                                strip.querySelector('.knob').dataset.state = isExc ? 2 : 1;
                                strip.querySelector('.knob').className = 'knob state-' + (isExc ? 2 : 1);
                            }
                        });
                    } else { 
                        const isComm = k.startsWith('#');
                        addOptionRow(isComm ? k.substring(1).trim() : k, v, isComm);
                    }
                } else if (raw.length > 2 && !raw.includes(':') && !['accs','flags'].includes(raw)) {
                    const isComm = raw.startsWith('#');
                    addOptionRow(isComm ? raw.substring(1).trim() : raw, "", isComm);
                }
            });
            if (container.children.length === 0) addOptionRow();
            else if (container.lastElementChild.querySelector('.sufu-input').value !== "") addOptionRow();
            isUpdating = false;
        }
    </script>
</body>
</html>
